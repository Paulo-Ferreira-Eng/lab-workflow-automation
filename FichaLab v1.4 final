import os
import tkinter as tk
from tkinter import messagebox
from reportlab.lib.pagesizes import A4, landscape
from reportlab.pdfgen import canvas
from datetime import datetime
import win32api
import sys
import win32print

# Splash screen
def mostrar_splash():
    splash = tk.Toplevel()
    splash.overrideredirect(True)
    splash.geometry("600x200+700+300") 

    
    splash.configure(bg="white")
    label = tk.Label(splash, text="LabFichas v3.2 Beta\n"
                                  "Desenvolvido por Paulo Ferreira\n"
                                  "Iniciando...", font=("Helvetica", 20, "bold"), bg="white", fg="#333333")
    label.pack(expand=True)

    splash.after(2000, splash.destroy)

    return splash

CHECKBOXES = {
    "BIOQUIMICA": [
        "Amilase", "√Åcido √örico", "Bilirrubina T.", "Bil. Direta", "Bil. Indireta",
        "C√°lcio I.", "Cloreto", "Colesterol T.", "Colesterol HDL", "Colesterol LDL",
        "Colesterol VLDL", "Creatinina", "LDH", "Ferro S√©rico", "Fosfatase Alc.",
        "GGT", "Glicose", "Pot√°ssio", "Prot. Totais", "Albumina", "S√≥dio",
        "TGO", "TGP", "Triglicer√≠deos", "Ur√©ia", "Ferritina", "Vitamina D",
        "Hemog. Glicada", "IgE", "BHCG"
    ],
    "HEMATOLOGIA": ["Reticul√≥citos"],
    "URINALISE": ["Gram"],
    "COPROLOGIA": ["Exame Parasitol√≥gico", "Sangue Oculto"]
}

def salvar_pdf(nome, nascimento, coleta, selecionados):

    if getattr(sys, 'frozen', False):
        base_dir = os.path.dirname(sys.executable)
    else:
        base_dir = os.path.dirname(os.path.abspath(__file__))

    data_str = datetime.today().strftime('%d-%m-%Y')
    pasta_base = os.path.join(base_dir, 'fichasmunicipal', data_str)
    os.makedirs(pasta_base, exist_ok=True)

    nome_base = os.path.join(pasta_base, nome)
    caminho = f"{nome_base}.pdf"
    count = 2
    while os.path.exists(caminho):
        caminho = f"{nome_base}{count}.pdf"
        count += 1

    c = canvas.Canvas(caminho, pagesize=landscape(A4))
    desenhar_ficha_completa(c, nome, nascimento, coleta, selecionados)
    c.save()
    return caminho

def imprimir_pdf(caminho):
    win32api.ShellExecute(0, "print", caminho, None, ".", 0)

def desenhar_ficha_completa(c, nome, dn, coleta, selecionados):
    largura, altura = landscape(A4)
    col_width = largura / 4
    margin = 20

    def draw_header(x, y):
        c.setFont("Helvetica-Bold", 11)
        c.drawCentredString(x + col_width / 2, y, "LAB. MUNICIPAL DE SJDR")
        y -= 14
        c.setFont("Helvetica", 10)
        c.drawString(x, y, f"Nome: {nome}")
        y -= 12
        c.drawString(x, y, f"Data de nascimento: {dn}")
        y -= 12
        c.drawString(x, y, f"Data da coleta: {coleta}")
        y -= 14
        c.line(x, y, x + col_width - margin, y)
        return y - 10

    def draw_checkbox_line(x, y, exame):
        estado = "x" if exame in selecionados else " "
        c.drawString(x, y, f"( {estado} ) {exame}: ")
        text_width = c.stringWidth(f"( {estado} ) {exame}: ", "Helvetica", 9)
        c.line(x + text_width + 2, y, x + col_width - margin, y)
        return y - 12

    def draw_field_line(x, y, label):
        texto = f"{label}:"
        c.drawString(x, y, texto)
        text_width = c.stringWidth(texto, "Helvetica", 9)
        c.line(x + text_width + 4, y, x + col_width - margin, y)
        return y - 12

    def draw_observacoes(x, y):
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        c.drawString(x, y, "Observa√ß√µes:")
        y -= 48
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        c.drawString(x, y, "Liberado por:")
        y -= 48
        return y

    def draw_bioquimica(x, y):
        y = draw_header(x, y)
        c.setFont("Helvetica-Bold", 9)
        c.drawCentredString(x + col_width / 2, y, "BIOQUIMICA")
        y -= 14
        c.setFont("Helvetica", 10)
        for exame in CHECKBOXES["BIOQUIMICA"]:
            y = draw_checkbox_line(x, y, exame)
        y = draw_observacoes(x, y)

    def draw_hematologia(x, y):
        y = draw_header(x, y)
        c.setFont("Helvetica-Bold", 9)
        c.drawCentredString(x + col_width / 2, y, "HEMATOLOGIA")
        y -= 14
        c.setFont("Helvetica", 10)
        for exame in [
            "Hem√°cias", "Hemat√≥crito", "Hemoglobina", "MCV", "MCH", "MCHC",
            "Leuc√≥citos", "Miel√≥citos", "Metamiel√≥citos", "Bastonetes",
            "Segmentados", "Bas√≥filos", "Eosin√≥filos", "Linf√≥citos",
            "Linf√≥cito reativo", "Mon√≥cito", "Plaqueta", "RDW"]:
            y = draw_field_line(x, y, exame)
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        estado = "x" if "Hemog. Glicada" in selecionados else " "
        c.drawString(x, y, f"( {estado} ) Hemog. Glicada")
        y -= 12
        estado = "x" if "Reticul√≥citos" in selecionados else " "
        c.drawString(x, y, f"( {estado} ) Reticul√≥citos:")
        y -= 24
        y = draw_observacoes(x, y)

    def draw_urinalise(x, y):
        y = draw_header(x, y)
        c.setFont("Helvetica-Bold", 9)
        c.drawCentredString(x + col_width / 2, y, "URIN√ÅLISE")
        y -= 14
        c.drawCentredString(x + col_width / 2, y, "Caracter√≠sticas F√≠sicas")
        y -= 14
        c.setFont("Helvetica", 9)
        for linha in [
            "Cor:  Claro  |  Citrino  |  Escuro  |  √¢mbar",
            "Cheiro:  Sui Generes    |    F√©tido",
            "Aspecto:  L√≠mpido  |  L. Turvo  |  Turvo",
            "Densidade:  1000 1005 1010 1015",
            "                          1020 1025 1030",
            "pH:  5  |  6  |  6,5  |  7  |  8  |  9"]:
            c.drawString(x, y, linha)
            y -= 12
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        c.setFont("Helvetica-Bold", 9)
        c.drawCentredString(x + col_width / 2, y, "Elementos Anormais")
        y -= 14
        c.setFont("Helvetica", 10)
        for campo in [
            "Prote√≠nas", "Glicose", "Cetona", "Hemoglobina", "Urobilinog√™nio",
            "Bilirrubina", "Nitrito", "Dep√≥sito"]:
            y = draw_field_line(x, y, campo)
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        c.setFont("Helvetica-Bold", 9)
        c.drawCentredString(x + col_width / 2, y, "Sedimentoscopia")
        y -= 14
        c.setFont("Helvetica", 10)
        for campo in [
            "Pi√≥citos", "C√©lulas Epiteliais", "Hem√°cias", "Cilindros",
            "Cristais", "Fil. de Muco", "Flora Bacteriana", "Leveduras"]:
            y = draw_field_line(x, y, campo)
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        estado = "x" if "Gram" in selecionados else " "
        c.drawString(x, y, f"( {estado} ) Gram:")
        y -= 24
        y = draw_observacoes(x, y)

    def draw_coprologia(x, y):
        y = draw_header(x, y)
        estado = "x" if "Exame Parasitol√≥gico" in selecionados else " "
        c.drawString(x, y, f"( {estado} ) Exame Parasitol√≥gico")
        y -= 58
        c.line(x, y, x + col_width - margin, y)
        y -= 12
        estado = "x" if "Sangue Oculto" in selecionados else " "
        c.drawString(x, y, f"( {estado} ) Sangue Oculto")
        y -= 12
        for i in range(1, 4):
            y -= 14
            c.drawCentredString(x + col_width / 2, y, f"{i}¬™ amostra: ____/____/______")
            y -= 14
            c.drawCentredString(x + col_width / 2, y, "Positivo (   )        |      Negativo (   )")
            y -= 14
            c.line(x, y, x + col_width - margin, y)
        y = draw_observacoes(x, y)
        y -= 50

        c.setFont("Helvetica-Bold", 13)
        c.drawCentredString(x + col_width / 2.5, y, "Laborat√≥rio Municipal / UPA")
        y -= 12
        c.drawCentredString(x + col_width / 2.5, y, "TEL: 0800 678 2000")
        y -= 12
        c.drawCentredString(x + col_width / 2.5, y, "Resultado de exame")
        y -= 20
        c.setFont("Helvetica", 10)
        c.drawString(x, y, "Dia: ____/____/_____ das 12h √†s 16h")
        y -= 14
        c.setFont("Helvetica", 10)
        c.drawString(x, y, f"Nome: {nome}")
        y -= 12
        c.setFont("Helvetica", 10)
        c.drawString(x, y, f"Data de nascimento: {dn}")
        y -= 20
        c.setFont("Helvetica-Oblique", 11)
        for linha in [
            "Entrega de resultado somente com",
            "este comprovante e documento",
            "com foto do paciente"]:
            c.drawCentredString(x + col_width / 2.5, y, linha)
            y -= 10

    x0 = margin
    x1 = x0 + col_width
    x2 = x1 + col_width
    x3 = x2 + col_width
    y_start = altura - margin

    draw_bioquimica(x0, y_start)
    draw_hematologia(x1, y_start)
    draw_urinalise(x2, y_start)
    draw_coprologia(x3, y_start)

class FichaApp:
    def __init__(self, root):
        self.root = root
        root.title("LabFichas v3.2 beta")
        root.iconbitmap("Brasao_sao_joao_del_rei.ico")
        root.geometry("600x750")
        root.resizable(True, True)

        # √çcone da janela (descomente se quiser usar um √≠cone personalizado)
        # root.iconbitmap("icone.ico")

        # ====== BARRA DE MENUS ======
        barra_menu = tk.Menu(root)
        root.config(menu=barra_menu)

        menu_arquivo = tk.Menu(barra_menu, tearoff=0)
        barra_menu.add_cascade(label="Arquivo", menu=menu_arquivo)
        menu_arquivo.add_command(label="Abrir Pasta de Fichas", command=self.abrir_pasta_fichas)

        menu_sobre = tk.Menu(barra_menu, tearoff=0)
        barra_menu.add_cascade(label="Sobre", menu=menu_sobre)
        menu_sobre.add_command(label="Sobre o Programa", command=self.mostrar_sobre)
        # ====== FIM BARRA DE MENUS ======

        # ====== T√çTULO PRINCIPAL ======
        titulo = tk.Label(root, text="Sistema de Fichas - Lab. Municipal SJDR", font=("Helvetica", 18, "bold"))
        titulo.grid(row=0, column=0, columnspan=2, pady=(10, 20))

        # ====== CAMPOS DE ENTRADA ======
        tk.Label(root, text="Nome do paciente:", font=("Helvetica", 12, "bold",)).grid(row=1, column=0, sticky="e")
        tk.Label(root, text="Data de nascimento:", font=("Helvetica", 12, "bold")).grid(row=2, column=0, sticky="e")
        tk.Label(root, text="Data da coleta:", font=("Helvetica", 12, "bold")).grid(row=3, column=0, sticky="e")

        self.nome_entry = tk.Entry(root, width=30)
        self.nascimento_entry = tk.Entry(root, width=30)
        self.coleta_entry = tk.Entry(root, width=30)

        self.nome_entry.grid(row=1, column=1, pady=2)
        self.nascimento_entry.grid(row=2, column=1, pady=2)
        self.coleta_entry.grid(row=3, column=1, pady=2)

        # Configurar ENTER para pular entre campos
        self.nome_entry.bind("<Return>", lambda e: self.focar_proximo(e, self.nascimento_entry))
        self.nascimento_entry.bind("<Return>", lambda e: self.focar_proximo(e, self.coleta_entry))

        # Formatadores de datas
        self.nascimento_entry.bind("<FocusOut>", lambda e: self.formatar_data_final(self.nascimento_entry, tipo="completo"))
        self.coleta_entry.bind("<FocusOut>", lambda e: self.formatar_data_final(self.coleta_entry, tipo="coleta"))

        # Permitir somente n√∫meros nas datas
        self.nascimento_entry.bind("<KeyPress>", self.permitir_apenas_numeros)
        self.coleta_entry.bind("<KeyPress>", self.permitir_apenas_numeros)

        # ====== FRAME DOS CHECKBOXES ======
        checkbox_frame = tk.Frame(root, relief=tk.SUNKEN, bd=1)
        checkbox_frame.grid(row=4, column=0, columnspan=2, padx=10, pady=10, sticky="nsew")

        root.grid_rowconfigure(4, weight=1)
        root.grid_columnconfigure(0, weight=1)
        root.grid_columnconfigure(1, weight=1)

        canvas_frame = tk.Canvas(checkbox_frame)
        scrollbar = tk.Scrollbar(checkbox_frame, orient="vertical", command=canvas_frame.yview)
        self.check_inner = tk.Frame(canvas_frame)

        self.check_inner.bind(
            "<Configure>",
            lambda e: canvas_frame.configure(scrollregion=canvas_frame.bbox("all"))
        )

        canvas_frame.create_window((0, 0), window=self.check_inner, anchor="nw")
        canvas_frame.configure(yscrollcommand=scrollbar.set)

        canvas_frame.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

        def _on_mousewheel(event):
            canvas_frame.yview_scroll(int(-1 * (event.delta / 120)), "units")
        canvas_frame.bind_all("<MouseWheel>", _on_mousewheel)

        # ====== CHECKBOXES DE EXAMES ======
        self.check_vars = {}

        frame_col1 = tk.Frame(self.check_inner)
        frame_col2 = tk.Frame(self.check_inner)
        frame_col3 = tk.Frame(self.check_inner)

        frame_col1.grid(row=0, column=0, sticky="n", padx=10)
        frame_col2.grid(row=0, column=1, sticky="n", padx=10)
        frame_col3.grid(row=0, column=2, sticky="n", padx=10)

        # Bioqu√≠mica dividida em duas colunas
        bioq_exames = CHECKBOXES["BIOQUIMICA"]
        half = (len(bioq_exames) + 1) // 2

        tk.Label(frame_col1, text="BIOQUIMICA", font=("Arial", 12, "bold")).pack(anchor="w", pady=(5, 5))
        for exame in bioq_exames[:half]:
            var = tk.BooleanVar()
            chk = tk.Checkbutton(frame_col1, text=exame , font=("Arial", 10), variable=var)
            chk.pack(anchor="w", pady=2)
            self.check_vars[exame] = var

        tk.Label(frame_col2, text="BIOQUIMICA", font=("Arial", 12, "bold")).pack(anchor="w", pady=(5, 5))
        for exame in bioq_exames[half:]:
            var = tk.BooleanVar()
            chk = tk.Checkbutton(frame_col2, text=exame , font=("Arial", 10), variable=var)
            chk.pack(anchor="w", pady=2)
            self.check_vars[exame] = var

        # Hematologia, Urin√°lise e Coprologia
        for grupo in ["HEMATOLOGIA", "URINALISE", "COPROLOGIA"]:
            tk.Label(frame_col3, text=grupo, font=("Arial", 12, "bold")).pack(anchor="w", pady=(10, 5))
            for exame in CHECKBOXES[grupo]:
                var = tk.BooleanVar()
                chk = tk.Checkbutton(frame_col3, text=exame , font=("Arial", 10), variable=var)
                chk.pack(anchor="w", pady=2)
                self.check_vars[exame] = var

        # ====== BOT√ïES LIMPAR E IMPRIMIR ======
        botoes_frame = tk.Frame(root)
        botoes_frame.grid(row=5, column=0, columnspan=2, pady=10)

        self.limpar_btn = tk.Button(botoes_frame, text="‚ùå Limpar", font=("Arial", 12), command=self.limpar, width=15)
        self.imprimir_btn = tk.Button(botoes_frame, text="üñ®Ô∏è Imprimir", font=("Arial", 12), command=self.imprimir, width=15)

        self.limpar_btn.grid(row=0, column=0, padx=20)
        self.imprimir_btn.grid(row=0, column=1, padx=20)

    # ====== FUN√á√ïES INTERNAS ======

    def abrir_pasta_fichas(self):
        import subprocess
        import sys
        import os

        if getattr(sys, 'frozen', False):
            base_dir = os.path.dirname(sys.executable)
        else:
            base_dir = os.path.dirname(os.path.abspath(__file__))

        pasta = os.path.join(base_dir, 'fichasmunicipal')
        if not os.path.exists(pasta):
            os.makedirs(pasta)

        subprocess.Popen(f'explorer "{pasta}"')

    def mostrar_sobre(self):
        messagebox.showinfo("Sobre o Programa",
                            "LabFichas v3.2 beta\n\n"
                            "Software cedido pelo criador.\n"
                            "Direitos reservados.\n"
                            "Proibida a venda e reprodu√ß√£o sem autoriza√ß√£o.\n\n"
                            "Desenvolvido por Paulo Ferreira.")

    def limpar(self):
        self.nome_entry.delete(0, tk.END)
        self.nascimento_entry.delete(0, tk.END)
        self.coleta_entry.delete(0, tk.END)
        for var in self.check_vars.values():
            var.set(False)

    def imprimir(self):
        self.formatar_data_final(self.nascimento_entry, tipo="completo")
        self.formatar_data_final(self.coleta_entry, tipo="coleta")

        nome = self.nome_entry.get().strip()
        nascimento = self.nascimento_entry.get().strip()
        coleta = self.coleta_entry.get().strip()

        if not nome or not nascimento or not coleta:
            messagebox.showerror("Erro", "Preencha todos os campos do paciente.")
            return

        selecionados = [exame for exame, var in self.check_vars.items() if var.get()]
        caminho_pdf = salvar_pdf(nome, nascimento, coleta, selecionados)
        imprimir_pdf(caminho_pdf)
        messagebox.showinfo("Sucesso", f"Ficha gerada e enviada para impress√£o!")

    def focar_proximo(self, event, proximo_campo):
        proximo_campo.focus_set()

    def formatar_data_final(self, campo, tipo="completo"):
        texto = campo.get().replace("/", "").strip()
        if tipo == "completo" and len(texto) == 8:
            resultado = f"{texto[:2]}/{texto[2:4]}/{texto[4:]}"
            campo.delete(0, tk.END)
            campo.insert(0, resultado)
        elif tipo == "coleta" and len(texto) == 4:
            resultado = f"{texto[:2]}/{texto[2:]}"
            campo.delete(0, tk.END)
            campo.insert(0, resultado)

    def permitir_apenas_numeros(self, event):
        if event.char.isdigit() or event.keysym in ("BackSpace", "Tab", "Left", "Right"):
            return
        else:
            return "break"

if __name__ == "__main__":
    root = tk.Tk()
    splash = mostrar_splash() 

    # splash
    root.withdraw()  
    splash.wait_window()  
    root.deiconify() 

    app = FichaApp(root)
    root.mainloop()
